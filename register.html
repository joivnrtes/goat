<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注册新账号</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #f8f8f8;
            color: #333;
        }
        .header {
            background-color: rgba(203, 210, 228, 0.9);
            color: #333;
            padding: 15px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
        }
        .form-container {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-size: 14px;
            margin-bottom: 5px;
            color: #333;
        }
        .form-group input, .form-group select {
            width: 96%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
        }
        .form-group select {
            height: 40px;
        }
        .avatar-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .avatar-container img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #ddd;
        }
        .file-input {
            margin-top: 10px;
            text-align: center;
        }
        .btn {
            width: 100%;
            padding: 10px;
            background-color: #f04e30;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #d13e27;
        }
        .btn-secondary {
            background-color: #ddd;
            color: black;
            border: none;
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background-color: #ccc;
        }
        .error-message {
            color: red;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">注册新账号</div>
    <div class="form-container">
        <form id="register-form">
            <div class="avatar-container">
                <img id="avatar-preview" src="default-avatar.png" alt=" ">
                <div class="file-input">
                    <label for="avatar-upload">上传头像</label>
                    <input type="file" id="avatar-upload" name="avatar" accept="image/*" onchange="previewAvatar(event)">
                </div>
            </div>
            <div class="form-group">
                <label for="username">用户名</label>
                <input type="text" id="username" name="username" placeholder="请输入用户名" required>
                <p class="error-message" id="username-error"></p>
            </div>
            <div class="form-group">
                <label for="email">邮箱</label>
                <input type="text" id="email" name="email" placeholder="请输入邮箱" required>
                <p class="error-message" id="email-error"></p>
            </div>
            <div class="form-group">
              <label for="verification-code">验证码</label>
              <div style="display: flex; align-items: center;">
                <input type="text" id="verification-code" name="verificationCode" placeholder="请输入验证码" style="flex: 3; margin-right: 10px;" required />
                <button type="button" class="btn-secondary" id="send-code-btn" onclick="sendVerificationCode()">发送验证码</button>
              </div>
              <p class="error-message" id="verification-error"></p>
            </div>
            <div class="form-group">
                <label for="password">密码</label>
                <input type="password" id="password" name="password" placeholder="请输入密码" required>
                <p class="error-message" id="password-error"></p>
            </div>
            <div class="form-group">
                <label for="gender">性别</label>
                <input type="string" id="gender" name="gender" placeholder="请输入您的性别">
            </div>
            <div class="form-group">
                <label for="height">身高(cm)</label>
                <input type="number" id="height" name="height" placeholder="请输入身高">
            </div>
            <div class="form-group">
                <label for="arm-span">臂展(cm)</label>
                <input type="number" id="arm-span" name="arm-span" placeholder="请输入臂展">
            </div>
            <div class="form-group">
                <label for="difficulty-level">难度水平</label>
                <select id="difficulty-level" name="difficulty-level">
                    <option value="">请选择</option>
                    <option value="5.3">5.3</option>
                    <option value="5.4">5.4</option>
                    <option value="5.5">5.5</option>
                    <option value="5.6">5.6</option>
                    <option value="5.7">5.7</option>
                    <option value="5.8">5.8</option>
                    <option value="5.9">5.9</option>
                    <option value="5.10a">5.10a</option>
                    <option value="5.10b">5.10b</option>
                    <option value="5.10c">5.10c</option>
                    <option value="5.10d">5.10d</option>
                    <option value="5.11a">5.11a</option>
                    <option value="5.11b">5.11b</option>
                    <option value="5.11c">5.11c</option>
                    <option value="5.11d">5.11d</option>
                    <option value="5.12a">5.12a</option>
                    <option value="5.12b">5.12b</option>
                    <option value="5.12c">5.12c</option>
                    <option value="5.12d">5.12d</option>
                    <option value="5.13a">5.13a</option>
                    <option value="5.13b">5.13b</option>
                    <option value="5.13c">5.13c</option>
                    <option value="5.13d">5.13d</option>
                    <option value="5.14a">5.14a</option>
                    <option value="5.14b">5.14b</option>
                    <option value="5.14c">5.14c</option>
                    <option value="5.14d">5.14d</option>
                    <option value="v1">v1</option>
                    <option value="v2">v2</option>
                    <option value="v3">v3</option>
                    <option value="v4">v4</option>
                    <option value="v5">v5</option>
                    <option value="v6">v6</option>
                    <option value="v7">v7</option>
                    <option value="v8">v8</option>
                    <option value="v9">v9</option>
                    <option value="v10">v10</option>
                    <option value="v11">v11</option>
                    <option value="v12">v12</option>
                    <option value="v13">v13</option>
                    <option value="v14">v14</option>
                    <option value="v15">v15</option>
                    <option value="v16">v16</option>
                </select>
            </div>
            <div class="form-group">
                <label for="climbing-duration">攀岩时长</label>
                <select id="climbing-duration" name="climbing-duration">
                    <option value="">请选择</option>
                    <script>
                        for (let i = 0; i <= 1200; i++) {
                            const years = Math.floor(i / 12);
                            const months = i % 12;
                            const label = years > 0 ? `${years}年${months}个月` : `${months}个月`;
                            document.write(`<option value="${label}">${label}</option>`);
                        }
                    </script>
                </select>
            </div>
            <div class="form-group">
                <label for="climbing-preference">攀岩偏好</label>
                <select id="climbing-preference" name="climbing-preference">
                    <option value="">请选择</option>
                    <option value="绳索攀岩">绳索攀岩</option>
                    <option value="抱石">抱石</option>
                    <option value="速攀">速攀</option>
                </select>
            </div>
            <button type="button" class="btn" onclick="validateAndSubmit()">注册</button>
        </form>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        function previewAvatar(event) {
            const avatarPreview = document.getElementById('avatar-preview');
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    avatarPreview.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                // 如果取消上传，恢复默认头像
                avatarPreview.src = 'default-avatar.png';
            }
        }
        function sendVerificationCode() {
            const email = document.getElementById('email').value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (!email || !emailRegex.test(email)) {
                alert('请输入有效的邮箱');
                return;
            }

            const button = document.getElementById('send-code-btn');
            button.disabled = true;
            button.textContent = '发送中...';

            fetch(`${API_BASE}/auth/send-verification-code`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email }),
           })
                .then((response) => response.json())
                .then((data) => {
                    alert(data.message);
                })
                .catch((error) => {
                    console.error('发送验证码错误:', error);
                    alert('发送验证码失败，请稍后重试。');
                })
                .finally(() => {
                    // 恢复按钮状态
                    button.disabled = false;
                    button.textContent = '发送验证码';
                });
        }

        function validateAndSubmit() {
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const verificationCode = document.getElementById('verification-code').value.trim();
            const password = document.getElementById('password').value.trim();
            const avatarFile = document.getElementById('avatar-upload').files[0];

            let isValid = true;

            // Validate username
            if (!username) {
                document.getElementById('username-error').textContent = '用户名不能为空';
                isValid = false;
            } else {
                document.getElementById('username-error').textContent = '';
            }

            // Validate email 
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email || !emailRegex.test(email)) {
                document.getElementById('email-error').textContent = '请输入有效的邮箱';
                isValid = false;
            } else {
                document.getElementById('email-error').textContent = '';
            }

            // 验证验证码
            if (!verificationCode) {
              document.getElementById('verification-error').textContent = '请输入验证码';
              isValid = false;
            } else {
              document.getElementById('verification-error').textContent = '';
            }


            // Validate password
            const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,16}$/;
            if (!password || !passwordRegex.test(password)) {
                document.getElementById('password-error').textContent = '密码必须是8到16位的字母、数字和特殊符号组合';
                isValid = false;
            } else {
                document.getElementById('password-error').textContent = '';
            }

            if (isValid) {
                const formData = new FormData();
                formData.append('username', username);
                formData.append('email', email);
                formData.append('verificationCode', verificationCode);
                formData.append('password', password);
                if (avatarFile) {
                  formData.append('avatar', avatarFile);
                }
                if (document.getElementById('gender').value.trim()) {
                  formData.append('gender', document.getElementById('gender').value.trim());
                }

                if (document.getElementById('height').value.trim()) {
                  formData.append('height', document.getElementById('height').value.trim());
                }
                if (document.getElementById('arm-span').value.trim()) {
                  formData.append('arm-span', document.getElementById('arm-span').value.trim());
                }
                if (document.getElementById('difficulty-level').value.trim()) {
                  formData.append('difficulty-level', document.getElementById('difficulty-level').value.trim());
                }
                if (document.getElementById('climbing-duration').value.trim()) {
                  formData.append('climbing-duration', document.getElementById('climbing-duration').value.trim());
                }
                if (document.getElementById('climbing-preference').value.trim()) {
                  formData.append('climbing-preference', document.getElementById('climbing-preference').value.trim());
                }

                fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    body: formData,
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            alert('注册成功！');
                        } else {
                            alert(`注册失败：${data.message || '未知错误'}`);
                        }
                    })
                    .catch((error) => {
                        console.error('注册请求出错:', error);
                        alert('注册失败，请稍后重试。');
                    });
            }
        }

    </script>
</body>
</html>